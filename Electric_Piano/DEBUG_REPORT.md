# 电子琴硬件调试问题分析与解决方案

## 问题描述
1. **LED显示异常**：LED2-8全亮，LED1灭，但系统设计为低电平点亮
2. **模式切换失效**：按四个按键（A/B/C/D）无法切换到自动播放模式

## 问题分析

### 1. LED显示问题
**现象分析**：
- 观察到LED2-8全亮，LED1灭
- 系统设计为低电平点亮LED
- 代码中led_display = 8'b11111110应该使LED1亮，其他灭

**可能原因**：
1. ✅ **LED极性配置错误**：之前修正了LED控制逻辑为负逻辑（低电平点亮）
2. ✅ **引脚分配错误**：已修正所有LED引脚分配到正确的FPGA引脚
3. **硬件连接问题**：LED硬件接线可能与预期不符

### 2. 按键响应问题
**现象分析**：
- 按A/B/C/D键无法切换模式
- 可能是按键编码或检测逻辑问题

**根本原因定位**：
1. ✅ **按键脉冲检测逻辑错误**：之前的边沿检测可能有问题
2. ✅ **参数定义重复**：Mode_Controller.v中有重复的parameter定义
3. ✅ **防抖动逻辑过于复杂**：简化为直接边沿检测

## 解决方案实施

### 1. 修正按键脉冲检测逻辑
**问题**：Array_KeyBoard.v中的按键脉冲检测方向错误
```verilog
// 原来（错误）：
assign key_pulse = key_scan_r & (~key_scan_rr);

// 修正后：
assign key_pulse = (~key_scan_r) & key_scan_rr;
```

**说明**：矩阵键盘按下时为低电平，应检测从高到低的变化

### 2. 优化模式切换逻辑
**改进**：
- 移除重复的parameter定义
- 简化防抖动逻辑，使用边沿检测
- 增加按键脉冲寄存器用于可靠的边沿检测

```verilog
// 新的边沿检测逻辑
reg [15:0] key_pulse_r;
always @(posedge clk) key_pulse_r <= key_pulse;

// 检测按键脉冲的上升沿
if (|key_pulse && !|key_pulse_r) begin
    // 模式切换逻辑
end
```

### 3. 按键编码确认
**4x4矩阵键盘布局**：
```
Row\Col   0      1      2      3
   0      1      2      3      A
   1      4      5      6      B  
   2      7      8      9      C
   3      *      0      #      D
```

**按键编码映射**：
- 1键：bit[0] = 16'h0001 ✅
- A键：bit[3] = 16'h0008 ✅  
- B键：bit[7] = 16'h0080 ✅
- C键：bit[11] = 16'h0800 ✅
- D键：bit[15] = 16'h8000 ✅

### 4. LED显示极性修正
**LED显示编码**（低电平点亮）：
- 手动模式：8'b11111110（LED1亮）
- 稻香模式：8'b11111101（LED2亮）
- 青花瓷模式：8'b11111011（LED3亮）
- 告白气球模式：8'b11110111（LED4亮）
- 简单爱模式：8'b11101111（LED5亮）

## 验证方法

### 1. 仿真验证
创建了Test_Bench.v文件，包含：
- 完整的按键仿真功能
- 自动化测试序列
- 关键信号监控

### 2. 硬件验证步骤
1. **重新编译项目**：确保所有修改生效
2. **下载到FPGA**：烧录更新的程序
3. **逐个测试按键**：
   - 按1键 → 检查LED1是否亮
   - 按A键 → 检查LED2是否亮，播放稻香
   - 按B键 → 检查LED3是否亮，播放青花瓷
   - 按C键 → 检查LED4是否亮，播放告白气球
   - 按D键 → 检查LED5是否亮，播放简单爱

### 3. 调试技巧
如果问题仍然存在：
1. **确认引脚分配**：检查Electric_Piano.qsf中的引脚设置
2. **示波器测试**：观察按键和LED信号的实际波形
3. **逐步调试**：先确保LED显示正常，再测试按键响应

## 文件修改清单
- ✅ **Mode_Controller.v**：修正参数定义、边沿检测逻辑、LED极性
- ✅ **Array_KeyBoard.v**：修正按键脉冲检测方向
- ✅ **Test_Bench.v**：新增仿真测试台
- ✅ **Electric_Piano.qsf**：引脚分配已修正

## 预期结果
修正后的系统应该能够：
1. 正确显示当前模式（只有对应的一个LED亮）
2. 响应A/B/C/D/1键的按键操作
3. 在自动播放模式下播放对应的音乐
4. 在手动模式下响应音符按键

## 下一步操作
1. 重新编译项目
2. 下载到FPGA进行硬件测试
3. 如有问题，使用仿真工具验证逻辑
4. 根据实际测试结果进一步调整

# LCD多图片显示平台使用指南

## 项目概述
基于FPGA的LCD多图片循环显示系统，支持240×160分辨率，2秒自动切换图片。

## 核心技术规格
- **分辨率**: 240×160像素
- **颜色格式**: RGB332 (9位：1位DC + 3位R + 3位G + 2位B)
- **时钟频率**: 10MHz (PLL: 12MHz × 5 ÷ 6)
- **切换间隔**: 2秒 (50,000,000个时钟周期)
- **图片数量**: 2张 (可扩展到4张)

## 硬件连接 (参考ballplayer.qsf)
```
LCD_RST  -> PIN_A8   # LCD复位
LCD_BLK  -> PIN_B7   # LCD背光控制
LCD_DC   -> PIN_A7   # 数据/命令选择
LCD_SCLK -> PIN_A6   # SPI时钟
LCD_MOSI -> PIN_A5   # SPI数据
LCD_CS   -> PIN_A4   # 片选信号
```

## 关键修复点

### 1. 时序问题修复
**问题**: 原25MHz时钟太快，导致显示异常
**解决**: 
- PLL配置改为10MHz输出
- 参数: clk1_multiply_by=5, clk1_divide_by=6

### 2. 分辨率错误修复
**解决**:
- 所有坐标计算改为240×160
- 像素总数: 38,400 (240×160)
- 地址范围: 0~38399

### 3. 定时器位宽修复
**问题**: 24位定时器溢出，无法达到2秒
**解决**:
- 改为26位: `reg [25:0] image_timer`
- 计数值: `26'd50000000` (2秒@25MHz基准)

### 4. 图片切换逻辑
**问题**: 5图片切换复杂，信号位宽不匹配
**解决**:
- 简化为2图片循环: `reg [1:0] current_image`
- 切换条件: `current_image >= 2'd1 ? 2'd0 : current_image + 1`

## 文件结构

### 核心模块
```
source/
├── ballplayer_multi_image_test.v        # 顶层模块
├── lcd_multi_image_display_240x160_fixed.v  # LCD显示控制器
├── multi_image_rom_240x160.v            # 多图片ROM选择器
├── ballplayer_pll.v                     # PLL时钟生成
├── image_0_rom.v                        # 图片0 ROM数据
├── image_1_rom.v                        # 图片1 ROM数据
├── lcd_init.v                           # LCD初始化
└── lcd_write.v                          # LCD写入控制
```

### 配置文件
- `ballplayer.qsf`: 项目配置和引脚分配
- `ballplayer_multi_image.sdc`: 时序约束

## 核心算法

### 坐标映射算法
```verilog
// 从像素计数器计算屏幕坐标
x_pos = pixel_counter % 240;
y_pos = pixel_counter / 240;

// 计算ROM地址 (线性寻址)
image_addr = y_pos * 240 + x_pos;

// 黑白格式：8像素打包成1字节
byte_addr = image_addr >> 3;  // 除以8
rom_addr = byte_addr[12:0];   // 13位地址
```

### 像素数据转换
```verilog
// 提取单个像素位
pixel_bit = rom_data[image_addr[2:0]];

// 转换为RGB332格式
if (pixel_bit) begin
    display_data = 9'b1_111_111_11; // 白色
end else begin
    display_data = 9'b1_000_000_00; // 黑色
end
```

### 状态机设计
```
IDLE -> INIT -> DISPLAY
         ↑        ↓
         └────────┘
```

## 调试检查点

### 编译检查
1. **0错误**: 语法正确
2. **时序分析**: 所有slack > 0
3. **引脚分配**: 无冲突警告

### 功能验证
1. **白屏测试**: Image 0显示全白
2. **条纹测试**: Image 1显示黑白条纹
3. **切换测试**: 2秒自动切换

### 常见问题

#### 显示分块问题
**原因**: 坐标计算错误或时钟频率过高
**解决**: 检查分辨率参数和PLL配置

#### 图片不切换
**原因**: 定时器位宽不足或切换逻辑错误
**解决**: 使用26位定时器，检查切换条件

#### 显示花屏
**原因**: ROM数据格式不匹配或地址计算错误
**解决**: 验证ROM数据格式和地址映射

## 扩展功能

### 增加图片数量
1. 修改 `current_image` 位宽
2. 更新 `multi_image_rom_240x160.v` 选择逻辑
3. 添加对应的ROM文件

### 调整切换间隔
```verilog
// 1秒切换: 26'd25000000
// 3秒切换: 26'd75000000
// 5秒切换: 26'd125000000 (需要27位定时器)
```

### 彩色显示支持
1. 修改ROM数据格式为RGB332
2. 更新像素数据处理逻辑
3. 调整地址计算 (彩色需要3倍存储)

## 维护注意事项

1. **时钟域**: 全部使用单一时钟域，避免跨时钟域问题
2. **复位策略**: 异步复位，同步释放
3. **位宽匹配**: 特别注意乘除法运算的位宽
4. **ROM格式**: 确保ROM数据格式与解析逻辑匹配
5. **引脚约束**: 修改引脚前检查硬件连接

## 性能优化建议

1. **流水线**: 可在像素数据处理中增加流水线级
2. **缓存**: 对频繁访问的ROM数据进行缓存
3. **并行处理**: 可考虑并行处理多个像素
4. **时钟优化**: 根据实际需求调整时钟频率

---
*文档版本: v1.0*  
*最后更新: 2025-05-31*  
*作者: GitHub Copilot*
